## Issues
- [Discussion about refactoring Pydrofoil build targets](https://github.com/pydrofoil/pydrofoil/issues/142)
  The SAIL team has confirmed that they are planning to integrate Pydrofoil into sail-riscv CI.

- [Missing bzip2/zlib from portable tarball created by `tool/release/package.py`](https://github.com/pypy/pypy/issues/5336)
  Packaging issue in PyPy release script.

## Commits

- [Fix workload linking with PyPy3 interpreter](https://github.com/OpenXiangShan/xs-env/commit/3ac81d778534a558db88f1876d6c2fd2bbb799cd)
  Pydrofoil can now *work*, at minimal level, with XiangShan co-simulation, yet halts at PyPy initialisation.
  ~~After [packaging PyPy3 interpreter with pydrofoil-riscv module](https://github.com/rpypkgs/rpypkgs/commit/15c008aa553c140cef28af1f553bb455718e4b74), XiangShan should work without build issues.~~
  Fixed by [In-tree build for pydrofoil-riscv, pypy-c-pydrofoil-riscv](https://github.com/pydrofoil/pydrofoil/pull/146)

- [(WIP) XiangShan co-simulation devShell]

  Fix suspicious linking issue of XiangShan sim `./build/emu` with pydrofoil-riscv-plugin.

  Directory structure of pydrofoil-riscv-plugin:

  ```sh
   result
  ├──  bin
  │   ├──  libpypy3-c.so -> libpypy3.11-c.so
  │   ├──  libpypy3.11-c.so
  │   ├──  libpypy3.11-c.so.debug
  │   ├── 󰡯 pypy -> pypy3.11
  │   ├── 󰡯 pypy3 -> pypy3.11
  │   ├──  pypy3.11
  │   ├──  pypy3.11.debug
  │   ├── 󰡯 python -> pypy3.11
  │   ├── 󰡯 python3 -> pypy3.11
  │   └──  python3.11 -> pypy3.11
  ├──  include
  │   ├──  pypy3.11
  │   └── 󰂺 README
  ├──  lib
  │   ├──  pypy3.11
  │   ├──  libbz2.so.1
  │   ├──  libexpat.so.1
  │   ├──  libffi.so.8
  │   ├──  libgdbm.so.6
  │   ├──  liblzma.so.5
  │   ├──  libncursesw.so.6
  │   ├──  libpanelw.so.6
  │   ├──  libsqlite3.so.0
  │   ├──  libtcl8.6.so
  │   ├──  libtk8.6.so
  │   ├──  libz.so.1
  │   └──  PYPY_PORTABLE_DEPS.txt
  ├──  LICENSE
  └──  README.rst
  ```

  Analyse of PyPy3 dynamic linking:

    ```sh
✦   ➜ ldd ./result/bin/libpypy3.11-c.so
	linux-vdso.so.1 (0x00007fdca7732000)
	libutil.so.1 => /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libutil.so.1 (0x00007fdca7725000)
	libdl.so.2 => /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libdl.so.2 (0x00007fdca7720000)
	libffi.so.8 => /nix/store/mkar3kd8gxsjayla2pm80i825ld4d6sb-pydrofoil-riscv-0.0.1-alpha0/lib/libffi.so.8 (0x00007fdca770f000)
	libm.so.6 => /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libm.so.6 (0x00007fdca0b18000)
	libbz2.so.1 => /nix/store/mkar3kd8gxsjayla2pm80i825ld4d6sb-pydrofoil-riscv-0.0.1-alpha0/lib/libbz2.so.1 (0x00007fdca76fb000)
	libz.so.1 => /nix/store/mkar3kd8gxsjayla2pm80i825ld4d6sb-pydrofoil-riscv-0.0.1-alpha0/lib/libz.so.1 (0x00007fdca76da000)
	librt.so.1 => /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/librt.so.1 (0x00007fdca76d5000)
	libncursesw.so.6 => /nix/store/mkar3kd8gxsjayla2pm80i825ld4d6sb-pydrofoil-riscv-0.0.1-alpha0/lib/libncursesw.so.6 (0x00007fdca0a9e000)
	libgcc_s.so.1 => /nix/store/0ja5daq2yay3svg6f48spyfby7pgy5bm-xgcc-14.3.0-libgcc/lib/libgcc_s.so.1 (0x00007fdca0a70000)
	libpthread.so.0 => /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libpthread.so.0 (0x00007fdca76d0000)
	libc.so.6 => /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libc.so.6 (0x00007fdca0800000)
	/nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib64/ld-linux-x86-64.so.2 (0x00007fdca7734000)

✦   ➜ ldd ./result/bin/pypy3.11
	linux-vdso.so.1 (0x00007f56803a0000)
	libpypy3.11-c.so => /home/definfo/Develop/pydrofoil/./result/bin/libpypy3.11-c.so (0x00007f5679800000)
	libpthread.so.0 => /nix/store/g8zyryr9cr6540xsyg4avqkwgxpnwj2a-glibc-2.40-66/lib/libpthread.so.0 (0x00007f5680393000)
	libc.so.6 => /nix/store/g8zyryr9cr6540xsyg4avqkwgxpnwj2a-glibc-2.40-66/lib/libc.so.6 (0x00007f5679400000)
	libutil.so.1 => /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libutil.so.1 (0x00007f568038e000)
	libdl.so.2 => /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libdl.so.2 (0x00007f5680389000)
	libffi.so.8 => /nix/store/mkar3kd8gxsjayla2pm80i825ld4d6sb-pydrofoil-riscv-0.0.1-alpha0/lib/libffi.so.8 (0x00007f5680376000)
	libm.so.6 => /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/libm.so.6 (0x00007f5679718000)
	libbz2.so.1 => /nix/store/mkar3kd8gxsjayla2pm80i825ld4d6sb-pydrofoil-riscv-0.0.1-alpha0/lib/libbz2.so.1 (0x00007f5680362000)
	libz.so.1 => /nix/store/mkar3kd8gxsjayla2pm80i825ld4d6sb-pydrofoil-riscv-0.0.1-alpha0/lib/libz.so.1 (0x00007f5680343000)
	librt.so.1 => /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib/librt.so.1 (0x00007f568033e000)
	libncursesw.so.6 => /nix/store/mkar3kd8gxsjayla2pm80i825ld4d6sb-pydrofoil-riscv-0.0.1-alpha0/lib/libncursesw.so.6 (0x00007f567969e000)
	libgcc_s.so.1 => /nix/store/0ja5daq2yay3svg6f48spyfby7pgy5bm-xgcc-14.3.0-libgcc/lib/libgcc_s.so.1 (0x00007f568030e000)
	/nix/store/g8zyryr9cr6540xsyg4avqkwgxpnwj2a-glibc-2.40-66/lib/ld-linux-x86-64.so.2 => /nix/store/776irwlgfb65a782cxmyk61pck460fs9-glibc-2.40-66/lib64/ld-linux-x86-64.so.2 (0x00007f56803a2000)
    ```

  Linking graph:

  ```
  pypy3.11 -> libpypy3.11-c.so -> libc.so.6
                               -> libutil.so.1
                               -> libbz2.so.1
                               -> (...)
  ```

  Main issues:

  - Specify C FFI generation process:

    As pydrofoil difftest workload is generated by Python cffi module
    (one codegen step from Python to C, followed by two compilation step using `cc` to generate `.o`/`.so` libraries),

    Thus we should look for a way to somehow bundle PyPy3 into the final `.so` workload.

  - Integration with XiangShan

    `PYDROFOIL_HOME=<some-path> ./build/emu -i $NOOP_HOME/ready-to-run/linux.bin`
  
  XiangShan build is heavy enough, thankfully we may not need recompiling XiangShan :)

- [pydrofoil: prepare pydrofoil difftest devShell within xs-env](https://github.com/definfo/xs-env/commit/73596f09cac8cae0b7870871cdcc5bde351567c8)
  Since this commit pydrofoil-riscv-plugin should work without library deps issues.
  
  Also document how to run co-simulation with Nix in `README.md`.

## PRs

- [In-tree build for pydrofoil-riscv, pypy-c-pydrofoil-riscv](https://github.com/pydrofoil/pydrofoil/pull/146)
  After heavily patching pypy2 sources, pydrofoil-riscv with PyPy plugin can successfully build with Nix. 

